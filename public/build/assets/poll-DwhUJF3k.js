import{r as l,j as t,c as $}from"./client-3DVn_WlK.js";function E({userId:y}){var b;const[x,h]=l.useState([]),[c,f]=l.useState(0),[j,m]=l.useState(null),[w,v]=l.useState({}),[N,g]=l.useState(!0),i=localStorage.getItem("auth_token"),s=x[c]||null,k=s?w[s.id]:!1;l.useEffect(()=>{if(!i)return;(async()=>{g(!0);try{const o=await(await fetch("/api/polls",{headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`}})).json();if(h(o),o.length>0){const d={};for(const a of o){const n=await P(a.id);d[a.id]=n}v(d)}}catch(r){console.error("Error loading polls",r)}finally{g(!1)}})()},[]);const P=async e=>{try{const o=await(await fetch(`/api/poll/${e}/check-vote`,{headers:{Authorization:`Bearer ${i}`}})).json();if(o.hasVoted){const a=await(await fetch(`/api/poll/${e}/results`,{headers:{Authorization:`Bearer ${i}`}})).json();h(n=>n.map(p=>p.id===e?{...p,results:a.results}:p))}return o.hasVoted}catch(r){return console.error(`Error checking vote status for poll ${e}`,r),!1}},S=async()=>{if(!j)return alert("Please select an option");try{const e=await fetch("/api/poll/vote",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({content_id:s.id,option_id:j})}),r=await e.json();if(e.ok){v(a=>({...a,[s.id]:!0}));const d=await(await fetch(`/api/poll/${s.id}/results`,{headers:{Authorization:`Bearer ${i}`}})).json();h(a=>a.map(n=>n.id===s.id?{...n,results:d.results}:n))}else alert(r.message||"Failed to vote.")}catch(e){console.error("Error submitting vote",e),alert("There was an error submitting your vote. Please try again.")}};return N?t.jsx("div",{children:"Loading poll..."}):s?t.jsxs("div",{className:"card shadow mt-4",children:[t.jsx("div",{className:"card-header bg-warning text-dark",children:t.jsx("h5",{className:"m-0",children:s.title})}),t.jsxs("div",{className:"card-body",children:[t.jsx("p",{children:s.description}),k?t.jsxs(t.Fragment,{children:[t.jsx("h6",{children:"Thank you for voting! Here are the results:"}),(b=s.results)==null?void 0:b.map(e=>t.jsxs("div",{className:"mb-2",children:[t.jsxs("div",{className:"d-flex justify-content-between mb-1",children:[t.jsx("strong",{children:e.option_text}),t.jsxs("small",{children:[e.percentage,"% (",e.votes," vote",e.votes!==1?"s":"",")"]})]}),t.jsx("div",{className:"progress",children:t.jsxs("div",{className:"progress-bar bg-success",role:"progressbar",style:{width:`${e.percentage||0}%`},"aria-valuenow":e.percentage||0,"aria-valuemin":"0","aria-valuemax":"100",children:[e.percentage||0,"%"]})})]},e.option_id))]}):t.jsxs(t.Fragment,{children:[s.options.map(e=>t.jsxs("div",{className:"form-check mb-2",children:[t.jsx("input",{className:"form-check-input",type:"radio",name:"pollOption",value:e.id,id:`option-${e.id}`,onChange:()=>m(e.id)}),t.jsx("label",{className:"form-check-label",htmlFor:`option-${e.id}`,children:e.option_text})]},e.id)),t.jsx("button",{className:"btn btn-primary mt-3",onClick:S,children:"Submit Vote"})]}),t.jsxs("div",{className:"d-flex justify-content-between mt-3",children:[t.jsx("button",{className:"btn btn-outline-secondary",disabled:c===0,onClick:()=>{f(c-1),m(null)},children:"← Previous"}),t.jsx("button",{className:"btn btn-outline-primary",disabled:c===x.length-1,onClick:()=>{f(c+1),m(null)},children:"Next →"})]})]})]}):t.jsx("div",{children:"No polls available right now."})}const u=document.getElementById("poll-app");u&&$.createRoot(u).render(t.jsx(E,{userId:u.dataset.user,token:u.dataset.token}));
